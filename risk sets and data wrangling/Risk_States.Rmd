---
title: "Risk_States.Rmd"
author: "Grace Rade"
date: "2023-01-30"
output: html_document
---
```{r}
library(tidyverse)
library(rio)
library(haven)
library(janitor)

all_risk_set <- read.csv("./datasets/all_risk_set.csv") %>% 
  clean_names() %>% 
  rename(statename = "state")

state_data <- read_csv("./datasets/risk_states1.csv")

state_data2 <- read_dta("./datasets/expanded_years.dta") %>% 
  mutate(incomepcap = floor(income))
  

state_data <- state_data %>% 
  full_join(state_data2)

evang <- read.csv("./datasets/evangelical_pop data.csv") %>% 
  select(year, state, evangelical_pop, st) %>% 
  filter(!is.na(evangelical_pop)) %>% 
  rename(statename = "state") %>% 
  rename(state = "st")


evang2 <- import("./datasets/ces_data.dta") %>% 
  rename(evangelical_pop = "pew_bornagain", statename = 'state_name') %>% 
  select(year, state, evangelical_pop, statename) %>% 
  mutate(evangelical_pop = evangelical_pop*100)

state2 <- state_data %>% 
  filter(year == c(2014, 2015)) %>% 
  select(year, state, statename) 

evang2$statename <- str_to_title(evang2$statename)
evang2 <- evang2 %>% 
  left_join(state2)

evang <- evang %>% 
  full_join(evang2)

risk_state <- all_risk_set %>% 
  full_join(state_data) %>% 
  mutate(duration = year - first_year, duration_sq = duration^2, duration_cub = duration^3) %>% 
  mutate(lawrence = ifelse(lag(adoption_year) <= 2003, 0, 1), obergefell = ifelse(lag(adoption_year) <= 2015, 0, 1))

risk_state <- risk_state %>% 
  left_join(evang) %>% 
  select(state, statename, year, policy, category, direction, adoption_year, population_total, pollib_median, incomepcap, std_bowen1, std_bowen2, unified, duration, duration_sq, duration_cub, nbrs_lag, nbrs, lawrence, obergefell, std_init_use, evangelical_pop) %>% 
  filter(year >=1987)

nums <- risk_state %>% 
  filter(is.na(evangelical_pop)) %>% 
  group_by(year) %>% 
  summarize(n())

```

```{r}
export(risk_state, "risk_states4.csv")
```

