---
title: "NewRiskSet"
author: "Grace Rade"
date: "2023-06-08"
output: html_document
---
```{r}
## loading packages
library(tidyverse)
library(haven)
library(rio)
library(janitor)
library(labelled)

policy_risk_set <- import("./datasets/all_risk_set.csv") %>% 
  clean_names() %>% 
  rename(state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## the risk set of all the policies w/o covariates

state_names <- import("./datasets/ces_data.dta") %>% 
  select(-inputstate) %>% 
  rename(evangelical_pop = "pew_bornagain") %>% 
  mutate(evangelical_pop = as.numeric(evangelical_pop*100), state = str_squish(state), state_name = str_squish(state_name)) ## name file for all + evangelical data

var_label(state_names$evangelical_pop) <- NULL ## get rid of the variable label
attributes(state_names$year) <- NULL ## remove all attributes
state_names$state_name[state_names$state_name == ""] <- NA ## sub out empties for NAs


#remove_attributes(state_names, "format.stata")

just_names <- state_names %>%
  select(c(state, state_name)) %>% 
  distinct() ## get just the name variables

names2014 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2014) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2014


names2015 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2015) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2015

#state_names <- state_names %>% 
 # full_join(names2014) %>% 
 # full_join(names2015)

race_health <- import("./datasets/race_health_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## covariates

expanded_years <- import("./datasets/expanded_years.dta") %>% 
  mutate(incomepcap = floor(income), statenam = str_squish(toupper(statenam))) %>% 
  rename(state_name = "statenam") ## expanded years covariates

state_data <- import("./datasets/state_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## more covariates

risk_set <- policy_risk_set %>% ## join the risk set to the name file
  ## at this point there are no missing values in the state-name or state variables
  left_join(race_health) %>% 
  left_join(expanded_years) ## get all the covariates in


evangelical1 <- import("./datasets/evangelical_pop data.csv") %>% 
  rename(state = "st", state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% 
  select(-c(state_fips, state_icpsr, stateno, V1)) ## first evangelical dataset

evangelical1 <- evangelical1 %>% 
  full_join(state_names) %>% 
  filter(year >= 1987, state != "DC") %>% 
  filter(!is.na(evangelical_pop))  ## trying to get the missing statenames to fill in (failure, why)

risk_set <- risk_set %>% 
  left_join(evangelical1) %>% 
  select(state, statename, year, policy, category, direction, adoption_year, population_total, pollib_median, incomepcap, std_bowen1, std_bowen2, unified, std_init_use, evangelical_pop) ## covairiates with the names fixed

## export(risk_set, "new_risk.csv")
  

```

```{r}
## let's see if we can fill anything in now

## population (from the )

library(tidycensus)

population2019 <- read_csv("./datasets/nst-est2019-alldata.csv") ## population estimates 2010-2019

population2019 <- population2019 %>% 
  filter(!row_number() %in% c(1:5)) ## get rid of rows I don't want at the top

population2019_2 <- population2019 %>% 
  filter(!STATE %in% c(11, 72)) %>%  ## get rid of rando rows I don't want
  clean_names() %>%  
  rename(state_name = "name", state_num = "state") %>%
  select(state_num, state_name, popestimate2015, popestimate2016, popestimate2017, popestimate2018, popestimate2019) %>% ## select variables I want
  mutate(state_name = str_squish(toupper(state_name))) %>% ## get state names all uppsercase to match
  left_join(unique(just_names)) ## join the state code variable

population2019_2 <- population2019_2 %>% 
  mutate(year2015 = 2015, year2016 = 2016, year2017 = 2017, year2018 = 2018, year2019 = 2019) ## making the year variable

population2015 <- population2019_2 %>% 
  select(state, state_name, year2015, popestimate2015) %>% ## select the cols i want
  rename(year = "year2015", population_total = "popestimate2015") ## rename

population2016 <-  population2019_2 %>% 
  select(state, state_name, year2016, popestimate2016) %>% 
  rename(year = "year2016", population_total = "popestimate2016")

population2017 <- population2019_2 %>% 
  select(state, state_name, year2017, popestimate2017) %>% 
  rename(year = "year2017", population_total = "popestimate2017")

population2018 <- population2019_2 %>% 
  select(state, state_name, year2018, popestimate2018) %>% 
  rename(year = "year2018", population_total = "popestimate2018")

population22001199 <- population2019_2 %>% 
  select(state, state_name, year2019, popestimate2019) %>% 
  rename(year = "year2019", population_total = "popestimate2019")

population2019 <- population2015 %>% 
  full_join(population2016) %>% 
  full_join(population2017) %>% 
  full_join(population2018) %>% 
  full_join(population22001199) ## got the population data all set for 2015-2019


population2022 <- read_csv("./datasets/NST-EST2022-ALLDATA.csv") ## population data 2020-2022

population2022 <- population2022 %>% 
  filter(!row_number() %in% c(1:14)) ## remove rows i don't want

population2022 <- population2022 %>% 
  filter(!STATE %in% c(11, 72)) %>%  ## get rid of rando rows I don't want
  clean_names() %>%  
  rename(state_name = "name", state_num = "state") ## rename vars to match 

population2022 <- population2022 %>% 
  select(state_num, state_name, popestimate2020, popestimate2021, popestimate2022) %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## get state names all uppsercase to match
  left_join(unique(just_names))

population2020 <- population2022 %>% 
  select(state, state_name, popestimate2020) %>% ## select the vars i want
  rename(population_total = "popestimate2020") %>% ## rename variable
  mutate(year = 2020) ## add year variable

population2021 <- population2022 %>% 
  select(state, state_name, popestimate2021) %>% 
  rename(population_total = "popestimate2021") %>% 
  mutate(year = 2021)

population2022_2 <- population2022 %>% 
  select(state, state_name, state_num, popestimate2022) %>% 
  rename(population_total = "popestimate2022") %>% 
  mutate(year = 2022)

population2022 <- population2020 %>% 
  full_join(population2021) %>% 
  full_join(population2022_2) ##joining 2020, 2021, 2022

population2022 <- population2019 %>% 
  full_join(population2022) ## joining 2015-2019 with 2020-2022

#export(population2022, "population2015_2019.csv"). ## exporting the dataset
```

```{r}

## don't run this chunk

## evangelical population (from the cooperative election survey)

evangelical2022_2 <- import("./datasets/CES2022_clean.csv") ## evangelical data 2022

# evangelical2022 <- evangelical2022 %>% 
#   select(inputstate, pew_bornagain, commonweight) %>%
#   rename(state_num = 'inputstate') %>% 
#   mutate(state_num = as.character(state_num))
# 
# ## converting the state numbers to match population df
# evangelical2022$state_num[evangelical2022$state_num == "1"] <- "01"
# evangelical2022$state_num[evangelical2022$state_num == "2"] <- "02"
# evangelical2022$state_num[evangelical2022$state_num == "3"] <- "03"
# evangelical2022$state_num[evangelical2022$state_num == "4"] <- "04"
# evangelical2022$state_num[evangelical2022$state_num == "5"] <- "05"
# evangelical2022$state_num[evangelical2022$state_num == "6"] <- "06"
# evangelical2022$state_num[evangelical2022$state_num == "7"] <- "07"
# evangelical2022$state_num[evangelical2022$state_num == "8"] <- "08"
# evangelical2022$state_num[evangelical2022$state_num == "9"] <- "09"

number_of_states <- evangelical2022_2 %>% 
  group_by(as.numeric(state_num)) %>% 
  summarize(n()) ## checking for stuff idk

evangelical2022 <- evangelical2022_2 %>% 
  mutate(state_num = as.character(state_num)) %>% 
  full_join(population2022_2) ## why is this not all of the states (AL, AK, AZ, AR, CA, CO, CT excluded somehow), might be a problem with the merging (cries)


weights <- evangelical2022 %>% 
  group_by(state) %>% 
  summarize(weight = mean(commonweight)) %>% 
  filter(!is.na(state))

attempted_collapse <- evangelical2022 %>% 
  group_by(state, pew_bornagain) %>% 
  summarize(num = n()) %>% 
  full_join(weights) %>% ##summarizing the weights (idk if this is right)
  group_by(state) %>% ##group by state again (weight variable should be statewide not state-answer)
  mutate(total = sum(num), evangelical_pop = ((num/(total)*weight)*100)) %>% ## get the percent evangelical (idk if this is right)
  filter(pew_bornagain == "1", !is.na(state)) %>%  ## getting rid of NAs and born again = 2 (no)
  mutate(year = 2022)

## mean weight is correct, but it needs to be by state
attempted_collapse

#export(attempted_collapse, "evangelical2022.csv") 2022 only, for Scott
#export(evangelical2022, "CES2022_clean.csv") cleaned data, only the vars we need
```

```{r}
## evangelical 2021 data (from the cooperative election survey)

## load the r data file (why are they like this it's harvard come on)
evangelical2021 <- as.data.frame(table)

str(evangelical2021)

evangelical2021 <- evangelical2021 %>% 
  select(inputstate, pew_bornagain, commonweight) %>%
  rename(state_num = 'inputstate') %>% 
  mutate(state_num = as.character(state_num))

## converting the state numbers to match population df
evangelical2021$state_num[evangelical2021$state_num == "1"] <- "01"
evangelical2021$state_num[evangelical2021$state_num == "2"] <- "02"
evangelical2021$state_num[evangelical2021$state_num == "3"] <- "03"
evangelical2021$state_num[evangelical2021$state_num == "4"] <- "04"
evangelical2021$state_num[evangelical2021$state_num == "5"] <- "05"
evangelical2021$state_num[evangelical2021$state_num == "6"] <- "06"
evangelical2021$state_num[evangelical2021$state_num == "7"] <- "07"
evangelical2021$state_num[evangelical2021$state_num == "8"] <- "08"
evangelical2021$state_num[evangelical2021$state_num == "9"] <- "09"

## get rid of attributes
attributes(evangelical2021$pew_bornagain) <- NULL
attributes(evangelical2021$commonweight) <- NULL

## join with population to get all the state ID vars
evangelical2021 <- evangelical2021 %>% 
  full_join(population2022_2) %>% 
  select(-c(population_total, year))

weights2021 <- evangelical2021 %>% 
  group_by(state) %>% 
  summarize(weight = mean(commonweight)) %>% 
  filter(!is.na(state))

attempted_collapse2021 <- evangelical2021 %>% 
  group_by(state, pew_bornagain) %>% 
  summarize(num = n()) %>% 
  full_join(weights) %>% ##summarizing the weights (idk if this is right)
  group_by(state) %>% ##group by state again (weight variable should be statewide not state-answer)
  mutate(total = sum(num), evangelical_pop = ((num/(total)*weight)*100)) %>% ## get the percent evangelical (idk if this is right)
  filter(pew_bornagain == "1", !is.na(state)) %>% 
  mutate(year = 2021)

## join 2021 and 2022
evangelical2122 <- attempted_collapse %>% 
  full_join(attempted_collapse2021) %>% 
  filter(state != "")

## export(evangelical2122, "evangelical2021_2011.csv") ## export it 
```

```{r}
## incomepcap (from US Dept. of Commerce Bureau of Economic Analysis )

incomepcap <- import("./datasets/income20112022.csv") ## import the dataset

incomepcap <- incomepcap %>% 
  rename(state_name = "GeoName") ## rename the name variable

incomepcap <- incomepcap %>% 
  filter(GeoFips != 0 & GeoFips != 11000) %>% ## drop the rows I don't want 
  select(-GeoFips) ## drop the variable I don't want

incomepcap <- incomepcap %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## match the state name when i merge
  left_join(just_names) %>% ## bring in state variable
  clean_names() ## clean names (why are they just numbers)

income2011 <- incomepcap %>% 
  select(state, state_name, x2011) %>% ## select the stuff for just the year i want
  rename(incomepcap = 'x2011') %>% ## rename to match risk set
  mutate(year = 2011) ## add year

income2012 <- incomepcap %>% 
  select(state, state_name, x2012) %>% 
  rename(incomepcap = 'x2012') %>% 
  mutate(year = 2012) ## repeating to 2012

income2013 <- incomepcap %>% 
  select(state, state_name, x2013) %>% 
  rename(incomepcap = 'x2013') %>% 
  mutate(year = 2013) ## repeating to 2013

income2014 <- incomepcap %>% 
  select(state, state_name, x2014) %>% 
  rename(incomepcap = 'x2014') %>% 
  mutate(year = 2014) ## repeating to 2014

income2015 <- incomepcap %>% 
  select(state, state_name, x2015) %>% 
  rename(incomepcap = 'x2015') %>% 
  mutate(year = 2015) ## repeating to 2015

income2016 <- incomepcap %>% 
  select(state, state_name, x2016) %>% 
  rename(incomepcap = 'x2016') %>% 
  mutate(year = 2016) ## repeating to 2016

income2017 <- incomepcap %>% 
  select(state, state_name, x2017) %>% 
  rename(incomepcap = 'x2017') %>% 
  mutate(year = 2017) ## repeating to 2017

income2018 <- incomepcap %>% 
  select(state, state_name, x2018) %>% 
  rename(incomepcap = 'x2018') %>% 
  mutate(year = 2018) ## repeating to 2018

income2019 <- incomepcap %>% 
  select(state, state_name, x2019) %>% 
  rename(incomepcap = 'x2019') %>% 
  mutate(year = 2019) ## repeating to 2019

income2020 <- incomepcap %>% 
  select(state, state_name, x2020) %>% 
  rename(incomepcap = 'x2020') %>% 
  mutate(year = 2020) ## repeating to 2020

income2021 <- incomepcap %>% 
  select(state, state_name, x2021) %>% 
  rename(incomepcap = 'x2021') %>% 
  mutate(year = 2021) ## repeating to 2021

income2022 <- incomepcap %>% 
  select(state, state_name, x2022) %>% 
  rename(incomepcap = 'x2022') %>% 
  mutate(year = 2022) ## repeating to 2022

incomepcap11_22 <- income2011 %>% ## join them all
  full_join(income2012) %>% 
  full_join(income2013) %>% 
  full_join(income2014) %>% 
  full_join(income2015) %>% 
  full_join(income2016) %>% 
  full_join(income2017) %>% 
  full_join(income2018) %>% 
  full_join(income2019) %>% 
  full_join(income2020) %>% 
  full_join(income2021) %>% 
  full_join(income2022)

## export(incomepcap11_22, "incomepcap2011_2022.csv") ## export
```

```{r}
## get just he populations for each year and state

risk_states <- import("./datasets/new_risk.csv") 
population <- risk_states %>% 
  select(year, statename, population_total) ## select cols I want
population <- population %>% 
  mutate(statename = str_squish(toupper(statename))) %>% ## fix names
  rename(state_name = "statename") %>% ## make variables match
  distinct() ## get rid fo extras

population_all <- population2022 %>% 
  select(state_name, year, population_total) %>% ## drop the state abbrev. var and state number
  full_join(population) %>% ## join with the big risk set
  filter(!is.na(population_total)) %>% ## get rid of the NA population/no state name
  arrange(year) # sort by year

pop_check <- population_all %>% 
  group_by(year) %>% 
  summarise(n()) ## check to see if there is 50 per year

# export(population_all, "population_only2022.csv")

```

```{r}
## demographic data

census_dems <- import("./datasets/ACSDP1Y2021.DP05-2023-07-26T164727.csv") ## import the census bureau data 

check_race <- import("./datasets/race_health_data.dta") ## load in the existing data to check for coverage

check_race <- check_race %>% 
  select(state, statenam, pctblack, year) %>% 
  filter(year >= 1987)
```

