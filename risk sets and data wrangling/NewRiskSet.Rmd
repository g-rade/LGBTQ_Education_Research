---
title: "NewRiskSet"
author: "Grace Rade"
date: "2023-06-08"
output: html_document
---
```{r}
## loading packages
library(tidyverse)
library(haven)
library(rio)
library(janitor)
library(labelled)

policy_risk_set <- import("./datasets/all_risk_set.csv") %>% 
  clean_names() %>% 
  rename(state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## the risk set of all the policies w/o covariates

state_names <- import("./datasets/ces_data.dta") %>% 
  select(-inputstate) %>% 
  rename(evangelical_pop = "pew_bornagain") %>% 
  mutate(evangelical_pop = as.numeric(evangelical_pop*100), state = str_squish(state), state_name = str_squish(state_name)) ## name file for all + evangelical data

var_label(state_names$evangelical_pop) <- NULL ## get rid of the variable label
attributes(state_names$year) <- NULL ## remove all attributes
state_names$state_name[state_names$state_name == ""] <- NA ## sub out empties for NAs


#remove_attributes(state_names, "format.stata")

just_names <- state_names %>%
  select(c(state, state_name)) %>% 
  distinct() ## get just the name variables

names2014 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2014) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2014


names2015 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2015) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2015

#state_names <- state_names %>% 
 # full_join(names2014) %>% 
 # full_join(names2015)

race_health <- import("./datasets/race_health_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## covariates

expanded_years <- import("./datasets/expanded_years.dta") %>% 
  mutate(incomepcap = floor(income), statenam = str_squish(toupper(statenam))) %>% 
  rename(state_name = "statenam") ## expanded years covariates

state_data <- import("./datasets/state_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## more covariates

risk_set <- policy_risk_set %>% ## join the risk set to the name file
  ## at this point there are no missing values in the state-name or state variables
  left_join(race_health) %>% 
  left_join(expanded_years) ## get all the covariates in


evangelical1 <- import("./datasets/evangelical_pop data.csv") %>% 
  rename(state = "st", state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% 
  select(-c(state_fips, state_icpsr, stateno, V1)) ## first evangelical dataset

evangelical1 <- evangelical1 %>% 
  full_join(state_names) %>% 
  filter(year >= 1987, state != "DC") %>% 
  filter(!is.na(evangelical_pop))  ## trying to get the missing statenames to fill in (failure, why)

risk_set <- risk_set %>% 
  left_join(evangelical1) %>% 
  select(state, statename, year, policy, category, direction, adoption_year, population_total, pollib_median, incomepcap, std_bowen1, std_bowen2, unified, std_init_use, evangelical_pop) ## covairiates with the names fixed

## export(risk_set, "new_risk.csv")
  

```

```{r}
## let's see if we can fill anything in now

## population (from the )

library(tidycensus)

population2019 <- read_csv("./datasets/nst-est2019-alldata.csv") ## population estimates 2010-2019

population2019 <- population2019 %>% 
  filter(!row_number() %in% c(1:5)) ## get rid of rows I don't want at the top

population2019_2 <- population2019 %>% 
  filter(!STATE %in% c(11, 72)) %>%  ## get rid of rando rows I don't want
  clean_names() %>%  
  rename(state_name = "name", state_num = "state") %>%
  select(state_num, state_name, popestimate2015, popestimate2016, popestimate2017, popestimate2018, popestimate2019) %>% ## select variables I want
  mutate(state_name = str_squish(toupper(state_name))) %>% ## get state names all uppsercase to match
  left_join(unique(just_names)) ## join the state code variable

population2019_2 <- population2019_2 %>% 
  mutate(year2015 = 2015, year2016 = 2016, year2017 = 2017, year2018 = 2018, year2019 = 2019) ## making the year variable

population2015 <- population2019_2 %>% 
  select(state, state_name, year2015, popestimate2015) %>% ## select the cols i want
  rename(year = "year2015", population_total = "popestimate2015") ## rename

population2016 <-  population2019_2 %>% 
  select(state, state_name, year2016, popestimate2016) %>% 
  rename(year = "year2016", population_total = "popestimate2016")

population2017 <- population2019_2 %>% 
  select(state, state_name, year2017, popestimate2017) %>% 
  rename(year = "year2017", population_total = "popestimate2017")

population2018 <- population2019_2 %>% 
  select(state, state_name, year2018, popestimate2018) %>% 
  rename(year = "year2018", population_total = "popestimate2018")

population22001199 <- population2019_2 %>% 
  select(state, state_name, year2019, popestimate2019) %>% 
  rename(year = "year2019", population_total = "popestimate2019")

population2019 <- population2015 %>% 
  full_join(population2016) %>% 
  full_join(population2017) %>% 
  full_join(population2018) %>% 
  full_join(population22001199) ## got the population data all set for 2015-2019


population2022 <- read_csv("./datasets/NST-EST2022-ALLDATA.csv") ## population data 2020-2022

population2022 <- population2022 %>% 
  filter(!row_number() %in% c(1:14)) ## remove rows i don't want

population2022 <- population2022 %>% 
  filter(!STATE %in% c(11, 72)) %>%  ## get rid of rando rows I don't want
  clean_names() %>%  
  rename(state_name = "name", state_num = "state") ## rename vars to match 

population2022 <- population2022 %>% 
  select(state_num, state_name, popestimate2020, popestimate2021, popestimate2022) %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## get state names all uppsercase to match
  left_join(unique(just_names))

population2020 <- population2022 %>% 
  select(state, state_name, popestimate2020) %>% ## select the vars i want
  rename(population_total = "popestimate2020") %>% ## rename variable
  mutate(year = 2020) ## add year variable

population2021 <- population2022 %>% 
  select(state, state_name, popestimate2021) %>% 
  rename(population_total = "popestimate2021") %>% 
  mutate(year = 2021)

population2022_2 <- population2022 %>% 
  select(state, state_name, state_num, popestimate2022) %>% 
  rename(population_total = "popestimate2022") %>% 
  mutate(year = 2022)

population2022 <- population2020 %>% 
  full_join(population2021) %>% 
  full_join(population2022_2) ##joining 2020, 2021, 2022

population2022 <- population2019 %>% 
  full_join(population2022) ## joining 2015-2019 with 2020-2022

#export(population2022, "population2015_2019.csv"). ## exporting the dataset
```

```{r}

## don't run this chunk

## evangelical population (from the cooperative election survey)

evangelical2022_2 <- import("./datasets/CES2022_clean.csv") ## evangelical data 2022

# evangelical2022 <- evangelical2022 %>% 
#   select(inputstate, pew_bornagain, commonweight) %>%
#   rename(state_num = 'inputstate') %>% 
#   mutate(state_num = as.character(state_num))
# 
# ## converting the state numbers to match population df
# evangelical2022$state_num[evangelical2022$state_num == "1"] <- "01"
# evangelical2022$state_num[evangelical2022$state_num == "2"] <- "02"
# evangelical2022$state_num[evangelical2022$state_num == "3"] <- "03"
# evangelical2022$state_num[evangelical2022$state_num == "4"] <- "04"
# evangelical2022$state_num[evangelical2022$state_num == "5"] <- "05"
# evangelical2022$state_num[evangelical2022$state_num == "6"] <- "06"
# evangelical2022$state_num[evangelical2022$state_num == "7"] <- "07"
# evangelical2022$state_num[evangelical2022$state_num == "8"] <- "08"
# evangelical2022$state_num[evangelical2022$state_num == "9"] <- "09"

number_of_states <- evangelical2022_2 %>% 
  group_by(as.numeric(state_num)) %>% 
  summarize(n()) ## checking for stuff idk

evangelical2022 <- evangelical2022_2 %>% 
  mutate(state_num = as.character(state_num)) %>% 
  full_join(population2022_2) ## why is this not all of the states (AL, AK, AZ, AR, CA, CO, CT excluded somehow), might be a problem with the merging (cries)


weights <- evangelical2022 %>% 
  group_by(state) %>% 
  summarize(weight = mean(commonweight)) %>% 
  filter(!is.na(state))

attempted_collapse <- evangelical2022 %>% 
  group_by(state, pew_bornagain) %>% 
  summarize(num = n()) %>% 
  full_join(weights) %>% ##summarizing the weights (idk if this is right)
  group_by(state) %>% ##group by state again (weight variable should be statewide not state-answer)
  mutate(total = sum(num), evangelical_pop = ((num/(total)*weight)*100)) %>% ## get the percent evangelical (idk if this is right)
  filter(pew_bornagain == "1", !is.na(state)) %>%  ## getting rid of NAs and born again = 2 (no)
  mutate(year = 2022)

## mean weight is correct, but it needs to be by state
attempted_collapse

#export(attempted_collapse, "evangelical2022.csv") 2022 only, for Scott
#export(evangelical2022, "CES2022_clean.csv") cleaned data, only the vars we need
```

```{r}
## evangelical 2021 data (from the cooperative election survey)

## load the r data file (why are they like this it's harvard come on)
evangelical2021 <- as.data.frame(table)

str(evangelical2021)

evangelical2021 <- evangelical2021 %>% 
  select(inputstate, pew_bornagain, commonweight) %>%
  rename(state_num = 'inputstate') %>% 
  mutate(state_num = as.character(state_num))

## converting the state numbers to match population df
evangelical2021$state_num[evangelical2021$state_num == "1"] <- "01"
evangelical2021$state_num[evangelical2021$state_num == "2"] <- "02"
evangelical2021$state_num[evangelical2021$state_num == "3"] <- "03"
evangelical2021$state_num[evangelical2021$state_num == "4"] <- "04"
evangelical2021$state_num[evangelical2021$state_num == "5"] <- "05"
evangelical2021$state_num[evangelical2021$state_num == "6"] <- "06"
evangelical2021$state_num[evangelical2021$state_num == "7"] <- "07"
evangelical2021$state_num[evangelical2021$state_num == "8"] <- "08"
evangelical2021$state_num[evangelical2021$state_num == "9"] <- "09"

## get rid of attributes
attributes(evangelical2021$pew_bornagain) <- NULL
attributes(evangelical2021$commonweight) <- NULL

## join with population to get all the state ID vars
evangelical2021 <- evangelical2021 %>% 
  full_join(population2022_2) %>% 
  select(-c(population_total, year))

weights2021 <- evangelical2021 %>% 
  group_by(state) %>% 
  summarize(weight = mean(commonweight)) %>% 
  filter(!is.na(state))

attempted_collapse2021 <- evangelical2021 %>% 
  group_by(state, pew_bornagain) %>% 
  summarize(num = n()) %>% 
  full_join(weights) %>% ##summarizing the weights (idk if this is right)
  group_by(state) %>% ##group by state again (weight variable should be statewide not state-answer)
  mutate(total = sum(num), evangelical_pop = ((num/(total)*weight)*100)) %>% ## get the percent evangelical (idk if this is right)
  filter(pew_bornagain == "1", !is.na(state)) %>% 
  mutate(year = 2021)

## join 2021 and 2022
evangelical2122 <- attempted_collapse %>% 
  full_join(attempted_collapse2021) %>% 
  filter(state != "")

## export(evangelical2122, "evangelical2021_2011.csv") ## export it 
```

```{r}
## incomepcap (from US Dept. of Commerce Bureau of Economic Analysis )

incomepcap <- import("./datasets/income20112022.csv") ## import the dataset

incomepcap <- incomepcap %>% 
  rename(state_name = "GeoName") ## rename the name variable

incomepcap <- incomepcap %>% 
  filter(GeoFips != 0 & GeoFips != 11000) %>% ## drop the rows I don't want 
  select(-GeoFips) ## drop the variable I don't want

incomepcap <- incomepcap %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## match the state name when i merge
  left_join(just_names) %>% ## bring in state variable
  clean_names() ## clean names (why are they just numbers)

income2011 <- incomepcap %>% 
  select(state, state_name, x2011) %>% ## select the stuff for just the year i want
  rename(incomepcap = 'x2011') %>% ## rename to match risk set
  mutate(year = 2011) ## add year

income2012 <- incomepcap %>% 
  select(state, state_name, x2012) %>% 
  rename(incomepcap = 'x2012') %>% 
  mutate(year = 2012) ## repeating to 2012

income2013 <- incomepcap %>% 
  select(state, state_name, x2013) %>% 
  rename(incomepcap = 'x2013') %>% 
  mutate(year = 2013) ## repeating to 2013

income2014 <- incomepcap %>% 
  select(state, state_name, x2014) %>% 
  rename(incomepcap = 'x2014') %>% 
  mutate(year = 2014) ## repeating to 2014

income2015 <- incomepcap %>% 
  select(state, state_name, x2015) %>% 
  rename(incomepcap = 'x2015') %>% 
  mutate(year = 2015) ## repeating to 2015

income2016 <- incomepcap %>% 
  select(state, state_name, x2016) %>% 
  rename(incomepcap = 'x2016') %>% 
  mutate(year = 2016) ## repeating to 2016

income2017 <- incomepcap %>% 
  select(state, state_name, x2017) %>% 
  rename(incomepcap = 'x2017') %>% 
  mutate(year = 2017) ## repeating to 2017

income2018 <- incomepcap %>% 
  select(state, state_name, x2018) %>% 
  rename(incomepcap = 'x2018') %>% 
  mutate(year = 2018) ## repeating to 2018

income2019 <- incomepcap %>% 
  select(state, state_name, x2019) %>% 
  rename(incomepcap = 'x2019') %>% 
  mutate(year = 2019) ## repeating to 2019

income2020 <- incomepcap %>% 
  select(state, state_name, x2020) %>% 
  rename(incomepcap = 'x2020') %>% 
  mutate(year = 2020) ## repeating to 2020

income2021 <- incomepcap %>% 
  select(state, state_name, x2021) %>% 
  rename(incomepcap = 'x2021') %>% 
  mutate(year = 2021) ## repeating to 2021

income2022 <- incomepcap %>% 
  select(state, state_name, x2022) %>% 
  rename(incomepcap = 'x2022') %>% 
  mutate(year = 2022) ## repeating to 2022

incomepcap11_22 <- income2011 %>% ## join them all
  full_join(income2012) %>% 
  full_join(income2013) %>% 
  full_join(income2014) %>% 
  full_join(income2015) %>% 
  full_join(income2016) %>% 
  full_join(income2017) %>% 
  full_join(income2018) %>% 
  full_join(income2019) %>% 
  full_join(income2020) %>% 
  full_join(income2021) %>% 
  full_join(income2022)

## export(incomepcap11_22, "incomepcap2011_2022.csv") ## export
```

```{r}
## get just he populations for each year and state

risk_states <- import("./datasets/new_risk.csv") 
population <- risk_states %>% 
  select(year, statename, population_total) ## select cols I want
population <- population %>% 
  mutate(statename = str_squish(toupper(statename))) %>% ## fix names
  rename(state_name = "statename") %>% ## make variables match
  distinct() ## get rid fo extras

population_all <- population2022 %>% 
  select(state_name, year, population_total) %>% ## drop the state abbrev. var and state number
  full_join(population) %>% ## join with the big risk set
  filter(!is.na(population_total)) %>% ## get rid of the NA population/no state name
  arrange(year) # sort by year

pop_check <- population_all %>% 
  group_by(year) %>% 
  summarise(n()) ## check to see if there is 50 per year

# export(population_all, "population_only2022.csv")

```

```{r}
## demographic data

census_dems <- import("./datasets/ACSDP1Y2021.DP05-2023-07-26T164727.csv") ## import the census bureau data 

check_race <- import("./datasets/race_health_data.dta") ## load in the existing data to check for coverage

check_race <- check_race %>% 
  select(state, statenam, pctblack, year) %>% 
  filter(year >= 1987, is.na(pctblack)) ## check for percent black coverage

check_sex <- race_health %>% 
  select(state, statenam, popfemale, year) %>% 
  filter(year >= 1987, is.na(popfemale)) ## check for female population coverage


## testing out the procedure 

census_dems2 <- census_dems %>% ## starting with making a new df
  select(`Label (Grouping)`, `SEX AND AGE!!Total population`) %>% ## select cols of interest (this is just a test)
  rename(state_name = "Label (Grouping)", sex = "SEX AND AGE!!Total population") ## rename cause ew

census_dems2 <- census_dems2 %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## filter the percents
  mutate(sex = ifelse(sex == "", NA, sex)) %>% ## get rid of empty cells
  fill(sex, .direction = c("up")) %>% ## fill the empty (slay)
  filter(state_name != "ESTIMATE") ## get rid of duplicate rows

## white population 2021
census_dems2021 <- census_dems %>% 
  select(`Label (Grouping)`, `RACE!!Total population!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)`, `RACE!!Total population!!One race!!Black or African American`, `SEX AND AGE!!Total population!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!Total population!!One race!!White", black_pop = "RACE!!Total population!!One race!!Black or African American", hispanic_pop = "HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Total population!!Female") ## rename vars

census_dems2021 <- census_dems2021 %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), black_pop = ifelse(black_pop == "", NA, black_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, black_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE") ## ok so this works for multipe vars, maybe a loop is not needed IDK

census_dems2021 <- census_dems2021 %>% 
  filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO"))  %>% ## drop PR and DC (sorry)
  mutate(year = 2021)
```

```{r}
## lets work on a loop 

census_names <- list.files("./datasets/census/", full.names = TRUE) ## a list of the names 

## ok i'm not sure that this is working, will check back later but i'mjust going to do it manually becuase they keep 
for (data in census_names){
 data = import(data) 
 data = data %>% 
   select(`Label (Grouping)`, `RACE!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)`, `RACE!!One race!!Black or African American`, `SEX AND AGE!!Total population!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!One race!!White", black_pop = "RACE!!One race!!Black or African American", hispanic_pop = "HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Total population!!Female")
 
 data = data %>% 
   mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), black_pop = ifelse(black_pop == "", NA, black_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, black_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE")
 
 data = data %>% 
   filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO")) ## drop PR and DC (sorry)
}

## i think the loop isn't working because the tables aren't the same year after year (fuck the census bureau for that)
```

```{r}
## census data, sans loop

## 2015
census2015 <- import("./datasets/census/census2015.csv") ## import it

census2015 <- census2015 %>% 
  select(`Label (Grouping)`, `RACE!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)`, `RACE!!One race!!Black or African American`, `SEX AND AGE!!Total population!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!One race!!White", black_pop = "RACE!!One race!!Black or African American", hispanic_pop = "HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Total population!!Female")

census2015 <- census2015 %>% 
   mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), black_pop = ifelse(black_pop == "", NA, black_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, black_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE")

census2015 <- census2015 %>% 
  filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO")) %>% ## filter out PR and DC
  mutate(year = 2015) ## add the year 


## 2016
census2016 <- import("./datasets/census/census2016.csv")

census2016 <- census2016 %>% 
  select(`Label (Grouping)`, `RACE!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)`, `RACE!!One race!!Black or African American`, `SEX AND AGE!!Total population!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!One race!!White", black_pop = "RACE!!One race!!Black or African American", hispanic_pop = "HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Total population!!Female")

census2016 <- census2016 %>% 
   mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), black_pop = ifelse(black_pop == "", NA, black_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, black_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE")

census2016 <- census2016 %>% 
  filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO")) %>% ## filter out PR and DC
  mutate(year = 2016) 

## 2017

census2017 <- import("./datasets/census/census2017.csv")

census2017 <- census2017 %>% 
  select(`Label (Grouping)`, `RACE!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)`, `RACE!!One race!!Black or African American`, `SEX AND AGE!!Total population!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!One race!!White", black_pop = "RACE!!One race!!Black or African American", hispanic_pop = "HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Total population!!Female")

census2017 <- census2017 %>% 
   mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), black_pop = ifelse(black_pop == "", NA, black_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, black_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE")

census2017 <- census2017 %>% 
  filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO")) %>% ## filter out PR and DC
  mutate(year = 2017)

## 2018

census2018 <- import("./datasets/census/census2018.csv")

census2018 <- census2018 %>% 
  select(`Label (Grouping)`, `RACE!!Total population!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)`, `RACE!!Total population!!One race!!Black or African American`, `SEX AND AGE!!Total population!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!Total population!!One race!!White", black_pop = "RACE!!Total population!!One race!!Black or African American", hispanic_pop = "HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Total population!!Female")

census2018 <- census2018 %>% 
   mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), black_pop = ifelse(black_pop == "", NA, black_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, black_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE")

census2018 <- census2018 %>% 
  filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO")) %>% ## filter out PR and DC
  mutate(year = 2018)

## 2019 

census2019 <- import("./datasets/census/census2019.csv")

census2019 <- census2019 %>% 
  select(`Label (Grouping)`, `RACE!!Total population!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)`, `RACE!!Total population!!One race!!Black or African American`, `SEX AND AGE!!Total population!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!Total population!!One race!!White", black_pop = "RACE!!Total population!!One race!!Black or African American", hispanic_pop = "HISPANIC OR LATINO AND RACE!!Total population!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Total population!!Female")

census2019 <- census2019 %>% 
   mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), black_pop = ifelse(black_pop == "", NA, black_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, black_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE")

census2019 <- census2019 %>% 
  filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO")) %>% ## filter out PR and DC
  mutate(year = 2019)

## now let's try to get some percentages with state population

census_dems20152021 <- census2015 %>% 
  full_join(census2016) %>% 
  full_join(census2017) %>% 
  full_join(census2018) %>% 
  full_join(census2019) %>% 
  full_join(census_dems2021) ## join them all together

census_dems20152021  <- census_dems20152021 %>% 
  left_join(population2022) ## join with population

census_dems20152021 <- census_dems20152021 %>% 
  select(-state_num) ## deselect the column that i don't need
  
census_dems20152021 <- census_dems20152021 %>% 
  mutate(female_pop = as.numeric(gsub(",", "", census_dems20152021$female_pop)), white_pop = as.numeric(gsub(",", "", census_dems20152021$white_pop)), black_pop = as.numeric(gsub(",", "", census_dems20152021$black_pop)), hispanic_pop = as.numeric(gsub(",", "", census_dems20152021$hispanic_pop))) %>% 
  mutate(pct_black = black_pop/population_total, pct_white = white_pop/population_total, pct_hispanic = hispanic_pop/population_total, pct_female = female_pop/population_total, pct_male = 1 - pct_female) ## boom we got it but no 2020 though, have to track that down separately


## export(census_dems20152021, "census_dems20152021.csv") ## export


## let's get some more years (2010-2014)
## these get tricky ughhhhhhh i hate the census bureau

## 2010
census2010 <- import("./datasets/census/census2010.csv")

census2010 <- census2010[, !duplicated(colnames(census2010))] ## get rid of duplicate columns

census2010 <- census2010 %>% 
   select(`Label (Grouping)`, `RACE!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Hispanic or Latino (of any race)`, `SEX AND AGE!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!One race!!White",  hispanic_pop = "HISPANIC OR LATINO AND RACE!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Female")

census2010 <- census2010 %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(state_name != "PERCENT") %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop)) %>% ## get rid of empty cells
  fill(white_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(state_name != "ESTIMATE")

census2010 <- census2010 %>% 
  filter(!state_name %in% c("DISTRICT OF COLUMBIA", "PUERTO RICO")) %>% ## filter out PR and DC
  mutate(year = 2010)

## 2011 (i figured this one out by myself slayyyyyyy)

census2011 <- import("./datasets/census/census2011.csv")

census2011 <- census2011[, !duplicated(colnames(census2011))] ## get rid of duplicate 

census2011 <- census2011 %>% select(`Label (Grouping)`, `SEX AND AGE!!Total population`, `RACE!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Hispanic or Latino (of any race)`, `SEX AND AGE!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!One race!!White",  hispanic_pop = "HISPANIC OR LATINO AND RACE!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Female", total_pop = "SEX AND AGE!!Total population")

census2011 <- census2011 %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(!total_pop %in% c("c", "(X)"), !state_name %in% c("2011 - 2009 STATISTICAL SIGNIFICANCE", "2011 - 2008 STATISTICAL SIGNIFICANCE", "2011 - 2007 STATISTICAL SIGNIFICANCE")) %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop), total_pop = ifelse(total_pop == "", NA, total_pop)) %>% ## get rid of empty cells
  fill(total_pop, white_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(!state_name %in% c("2011 ESTIMATE", "2010 ESTIMATE", "DISTRICT OF COLUMBIA", "PUERTO RICO")) ## filter extra rows

census2011 <- census2011 %>% 
  mutate(female_pop = as.numeric(gsub("%", "", census2011$female_pop)), white_pop = as.numeric(gsub("%", "", census2011$white_pop)), total_pop = as.numeric(gsub(",", "", census2011$total_pop)), hispanic_pop = as.numeric(gsub("%", "", census2011$hispanic_pop))) %>% ## make numeric and get rid of unwanted characters
  mutate(pct_white = white_pop/100, pct_female = female_pop/100, pct_hispanic = hispanic_pop/100) %>% ## percentage vars
  mutate(white_pop = total_pop*pct_white, female_pop = total_pop*pct_female, hispanic_pop = total_pop*pct_hispanic) ## get whole number population values

census2011 <- census2011 %>% 
  mutate(year = 2011) ## add year

## 2012

census2012 <- import("./datasets/census/census2012.csv")

census2012 <- census2012[, !duplicated(colnames(census2012))] ## get rid of duplicate cols

census2012 <- census2012 %>% 
  select(`Label (Grouping)`, `SEX AND AGE!!Total population`, `RACE!!One race!!White`, `HISPANIC OR LATINO AND RACE!!Hispanic or Latino (of any race)`, `SEX AND AGE!!Female`) %>% ## select vars
  rename(state_name = "Label (Grouping)", white_pop = "RACE!!One race!!White",  hispanic_pop = "HISPANIC OR LATINO AND RACE!!Hispanic or Latino (of any race)", female_pop = "SEX AND AGE!!Female", total_pop = "SEX AND AGE!!Total population")

census2012 <- census2012 %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## fix the state name vairable to get rid of spaces and lowercase
  filter(!total_pop %in% c("c", "(X)"), !state_name %in% c("2012 - 2010 STATISTICAL SIGNIFICANCE", "2012 - 2011 STATISTICAL SIGNIFICANCE", "2012 - 2009 STATISTICAL SIGNIFICANCE", "2012 - 2008 STATISTICAL SIGNIFICANCE")) %>% ## dump percent
  mutate(white_pop = ifelse(white_pop == "", NA, white_pop), hispanic_pop = ifelse(hispanic_pop == "", NA, hispanic_pop), female_pop = ifelse(female_pop == "", NA, female_pop), total_pop = ifelse(total_pop == "", NA, total_pop)) %>% ## get rid of empty cells
  fill(total_pop, white_pop, hispanic_pop, female_pop, .direction = "up") %>% ## fill!
  filter(!state_name %in% c("2011 ESTIMATE", "2010 ESTIMATE", "2012 ESTIMATE", "DISTRICT OF COLUMBIA", "PUERTO RICO")) ## filter extra rows

census2012 <- census2012 %>% 
  mutate(female_pop = as.numeric(gsub("%", "", census2012$female_pop)), white_pop = as.numeric(gsub("%", "", census2012$white_pop)), total_pop = as.numeric(gsub(",", "", census2012$total_pop)), hispanic_pop = as.numeric(gsub("%", "", census2012$hispanic_pop))) %>% ## make numeric and get rid of unwanted characters
  mutate(pct_white = white_pop/100, pct_female = female_pop/100, pct_hispanic = hispanic_pop/100) %>% ## percentage vars
  mutate(white_pop = total_pop*pct_white, female_pop = total_pop*pct_female, hispanic_pop = total_pop*pct_hispanic)

census2012 <- census2012 %>% 
  mutate(year = 2012) ## add year
  
```

```{r}
## lets standardize the initiatives

inits_exist <- state_data %>% 
  select(state, state_name, init, initiatives, year) %>%  ## there are two intitiative variables so I'm just doing both
  mutate(state_name = str_squish(toupper(state_name))) ## match them names bby

inits_new <- import("./datasets/init_data.csv") ## import the new stuff

inits_new <- inits_new %>% 
  mutate(init = num_init, state_name = str_squish(toupper(state_name))) %>% ## fix them names bby and duplicate some columns
  rename("initiatives" = num_init) ## rename so i have the duplicates

inits <- inits_exist %>% 
  full_join(inits_new) %>% ##full join
  select(-c(state_fips, state_num, state_icpsr)) ## drop the columns that don't fill in from the crosswalk file

inits <- inits %>% 
  mutate(initiaitves = as.numeric(initiatives), mean = mean(initiatives, na.rm = T), sd = sd(initiatives, na.rm = T), std_init_use = (initiatives - mean)/sd) ## calculate the new columns: mean, sd, std_init_use (completely recalculated)

#export(inits, "initiatives2023.csv") ## export
```

```{r}
## policy liberalism

crosswalk <- import("./datasets/state_codes.csv") ## import the crosswalk file

pollib_raw <- read_dta("./datasets/CaugheyWarshaw_DynamicDemocracyAmericanStates_Export_2021.dta") ## read in updated policy liberalism data

pollib_raw <- pollib_raw %>% 
  select(abb, year, policy_updated) %>% ## select vars
  rename(state = "abb", pollib_median = "policy_updated") ## rename to match existing var name

pollib_raw <- pollib_raw %>% 
  filter(year >= 2015, state != "DC") ## filter out DC and years we already have

pollib_raw <- pollib_raw %>% 
  left_join(crosswalk) ## join with the crosswalk file for all the state ID vars

pollib_raw <- pollib_raw %>% 
  mutate(statenam = str_squish(toupper(statenam))) %>% ## make uppercase, get rid of extra spaces
  rename(state_name = 'statenam') ## rename

crosswalk <- crosswalk %>% 
  mutate(statenam = str_squish(toupper(statenam))) %>% 
  rename(state_name = 'statenam') ## fix the crosswalk file for state name case and var name

## export(crosswalk, "state_codes.csv") ## export the fixed crosswalk file as the same file name (overwrite slay)

## export(pollib_raw, "pollib_median1520.csv") ## export pollib data

```

