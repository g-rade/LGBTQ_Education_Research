---
title: "NewRiskSet"
author: "Grace Rade"
date: "2023-06-08"
output: html_document
---
```{r}
## loading packages
library(tidyverse)
library(haven)
library(rio)
library(janitor)
library(labelled)

policy_risk_set <- import("./datasets/all_risk_set.csv") %>% 
  clean_names() %>% 
  rename(state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## the risk set of all the policies w/o covariates

state_names <- import("./datasets/ces_data.dta") %>% 
  select(-inputstate) %>% 
  rename(evangelical_pop = "pew_bornagain") %>% 
  mutate(evangelical_pop = as.numeric(evangelical_pop*100), state = str_squish(state), state_name = str_squish(state_name)) ## name file for all + evangelical data

var_label(state_names$evangelical_pop) <- NULL ## get rid of the variable label
attributes(state_names$year) <- NULL ## remove all attributes
state_names$state_name[state_names$state_name == ""] <- NA ## sub out empties for NAs


#remove_attributes(state_names, "format.stata")

just_names <- state_names %>%
  select(c(state, state_name)) ## get just the name variables

names2014 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2014) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2014


names2015 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2015) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2015

#state_names <- state_names %>% 
 # full_join(names2014) %>% 
 # full_join(names2015)

race_health <- import("./datasets/race_health_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## covariates

expanded_years <- import("./datasets/expanded_years.dta") %>% 
  mutate(incomepcap = floor(income), statenam = str_squish(toupper(statenam))) %>% 
  rename(state_name = "statenam") ## expanded years covariates

state_data <- import("./datasets/state_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## more covariates

risk_set <- policy_risk_set %>% ## join the risk set to the name file
  ## at this point there are no missing values in the state-name or state variables
  left_join(race_health) %>% 
  left_join(expanded_years) ## get all the covariates in


evangelical1 <- import("./datasets/evangelical_pop data.csv") %>% 
  rename(state = "st", state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% 
  select(-c(state_fips, state_icpsr, stateno, V1)) ## first evangelical dataset

evangelical1 <- evangelical1 %>% 
  full_join(state_names) %>% 
  filter(year >= 1987, state != "DC") %>% 
  filter(!is.na(evangelical_pop))  ## trying to get the missing statenames to fill in (failure, why)

risk_set <- risk_set %>% 
  left_join(evangelical1) %>% 
  select(state, statename, year, policy, category, direction, adoption_year, population_total, pollib_median, incomepcap, std_bowen1, std_bowen2, unified, std_init_use, evangelical_pop) ## covairiates with the names fixed

## export(risk_set, "new_risk.csv")
  

```

```{r}
## let's see if we can fill anything in now

library(tidycensus)

population2019 <- read_csv("nst-est2019-alldata.csv") ## population estimates 2010-2019

population2019 <- population2019 %>% 
  filter(!row_number() %in% c(1:5)) ## get rid of rows I don't want at the top

population2019_2 <- population2019 %>% 
  filter(!STATE %in% c(11, 72)) %>%  ## get rid of rando rows I don't want
  clean_names() %>%  
  rename(state_name = "name", state_num = "state") %>%
  select(state_num, state_name, popestimate2015, popestimate2016, popestimate2017, popestimate2018, popestimate2019) %>% ## select variables I want
  mutate(state_name = str_squish(toupper(state_name))) %>% ## get state names all uppsercase to match
  left_join(unique(just_names)) ## join the state code variable

population2019_2 <- population2019_2 %>% 
  mutate(year2015 = 2015, year2016 = 2016, year2017 = 2017, year2018 = 2018, year2019 = 2019) ## making the year variable

population2015 <- population2019_2 %>% 
  select(state, state_name, year2015, popestimate2015) %>% ## select the cols i want
  rename(year = "year2015", population_total = "popestimate2015") ## rename

population2016 <-  population2019_2 %>% 
  select(state, state_name, year2016, popestimate2016) %>% 
  rename(year = "year2016", population_total = "popestimate2016")

population2017 <- population2019_2 %>% 
  select(state, state_name, year2017, popestimate2017) %>% 
  rename(year = "year2017", population_total = "popestimate2017")

population2018 <- population2019_2 %>% 
  select(state, state_name, year2018, popestimate2018) %>% 
  rename(year = "year2018", population_total = "popestimate2018")

population22001199 <- population2019_2 %>% 
  select(state, state_name, year2019, popestimate2019) %>% 
  rename(year = "year2019", population_total = "popestimate2019")

population2019 <- population2015 %>% 
  full_join(population2016) %>% 
  full_join(population2017) %>% 
  full_join(population2018) %>% 
  full_join(population22001199) ## got the population data all set for 2015-2019


population2022 <- read_csv("./datasets/NST-EST2022-ALLDATA.csv") ## population data 2020-2022

population2022 <- population2022 %>% 
  filter(!row_number() %in% c(1:14)) ## remove rows i don't want

population2022 <- population2022 %>% 
  filter(!STATE %in% c(11, 72)) %>%  ## get rid of rando rows I don't want
  clean_names() %>%  
  rename(state_name = "name", state_num = "state") ## rename vars to match 

population2022 <- population2022 %>% 
  select(state_num, state_name, popestimate2020, popestimate2021, popestimate2022) %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% ## get state names all uppsercase to match
  left_join(unique(just_names))

population2020 <- population2022 %>% 
  select(state, state_name, popestimate2020) %>% ## select the vars i want
  rename(population_total = "popestimate2020") %>% ## rename variable
  mutate(year = 2020) ## add year variable

population2021 <- population2022 %>% 
  select(state, state_name, popestimate2021) %>% 
  rename(population_total = "popestimate2021") %>% 
  mutate(year = 2021)

population2022_2 <- population2022 %>% 
  select(state, state_name, state_num, popestimate2022) %>% 
  rename(population_total = "popestimate2022") %>% 
  mutate(year = 2022)

population2022 <- population2020 %>% 
  full_join(population2021) %>% 
  full_join(population2022_2) ##joining 2020, 2021, 2022

population2022 <- population2019 %>% 
  full_join(population2022) ## joining 2015-2019 with 2020-2022

#export(population2022, "population2015_2019.csv"). ## exporting the dataset
```

```{r}
## evangelical population

evangelical2022 <- import("./datasets/CES22_Common.csv") ## evangelical data 2022

evangelical2022 <- evangelical2022 %>% 
  select(inputstate, pew_bornagain) %>%
  rename(state_num = 'inputstate') %>% 
  mutate(state_num = as.character(state_num))

number_of_states <- evangelical2022 %>% 
  group_by(state_num) %>% 
  summarize(n())

evangelical2022 <- evangelical2022 %>% 
  full_join(population2022_2) ## why is this not all of the states (AL, AK, AZ, AR, CA, CO, CT excluded somehow), might be a problem with the merging (cries)
```

