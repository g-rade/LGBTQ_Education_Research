---
title: "NewRiskSet"
author: "Grace Rade"
date: "2023-06-08"
output: html_document
---
```{r}
## loading packages
library(tidyverse)
library(haven)
library(rio)
library(janitor)
library(labelled)

policy_risk_set <- import("./datasets/all_risk_set.csv") %>% 
  clean_names() %>% 
  rename(state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## the risk set of all the policies w/o covariates

state_names <- import("./datasets/ces_data.dta") %>% 
  select(-inputstate) %>% 
  rename(evangelical_pop = "pew_bornagain") %>% 
  mutate(evangelical_pop = as.numeric(evangelical_pop*100), state = str_squish(state), state_name = str_squish(state_name)) ## name file for all + evangelical data

var_label(state_names$evangelical_pop) <- NULL ## get rid of the variable label
attributes(state_names$year) <- NULL ## remove all attributes
state_names$state_name[state_names$state_name == ""] <- NA ## sub out empties for NAs


#remove_attributes(state_names, "format.stata")

just_names <- state_names %>%
  select(c(state, state_name)) ## get just the name variables

names2014 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2014) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2014


names2015 <- state_names %>% 
  select(state_name, state) %>% 
  distinct() %>% 
  mutate(year = 2015) %>% 
  filter(!is.na(state_name)) %>% 
  filter(state_name != "DISTRICT OF COLUMBIA") ## filling in the full state names for 2015

#state_names <- state_names %>% 
 # full_join(names2014) %>% 
 # full_join(names2015)

race_health <- import("./datasets/race_health_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## covariates

expanded_years <- import("./datasets/expanded_years.dta") %>% 
  mutate(incomepcap = floor(income), statenam = str_squish(toupper(statenam))) %>% 
  rename(state_name = "statenam") ## expanded years covariates

state_data <- import("./datasets/state_data.dta") %>% 
  mutate(state_name = str_squish(toupper(state_name))) ## more covariates

risk_set <- policy_risk_set %>% ## join the risk set to the name file
  ## at this point there are no missing values in the state-name or state variables
  left_join(race_health) %>% 
  left_join(expanded_years) ## get all the covariates in


evangelical1 <- import("./datasets/evangelical_pop data.csv") %>% 
  rename(state = "st", state_name = "state") %>% 
  mutate(state_name = str_squish(toupper(state_name))) %>% 
  select(-c(state_fips, state_icpsr, stateno, V1)) ## first evangelical dataset

evangelical1 <- evangelical1 %>% 
  full_join(state_names) %>% 
  filter(year >= 1987, state != "DC") %>% 
  filter(!is.na(evangelical_pop))  ## trying to get the missing statenames to fill in (failure, why)

risk_set <- risk_set %>% 
  left_join(evangelical1) %>% 
  select(state, statename, year, policy, category, direction, adoption_year, population_total, pollib_median, incomepcap, std_bowen1, std_bowen2, unified, std_init_use, evangelical_pop) ## covairiates with the names fixed

## export(risk_set, "new_risk.csv")
  

```

```{r}
## let's see if we can fill anything in now

library(tidycensus)

population2019 <- read_csv("nst-est2019-alldata.csv") ## population estimates 2010-2019
```

